<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APA ‚Ä¢ Depto. Personal ‚Ä¢ Sistema de Registros</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">APA</div>
      <div>
        <div class="title">Sistema de Registros</div>
        <div class="subtitle">Depto. Personal ‚Ä¢ Entradas ‚Ä¢ Asignaciones ‚Ä¢ Merma ‚Ä¢ Solicitudes ‚Ä¢ Informes</div>
      </div>
    </div>

    <div class="userbox" id="userBox" hidden>
      <div class="user-meta">
        <div class="user-name" id="userName">‚Äî</div>
        <div class="user-role" id="userRole">‚Äî</div>
      </div>
      <button class="btn btn--danger" id="btnLogout" type="button">Salir</button>
    </div>
  </header>

  <main class="container">

    <!-- LOGIN (lo √∫nico visible antes de loguear) -->
    <section class="card login-card" id="loginCard">
      <h2>Ingreso al sistema</h2>
      <p class="muted">Acceso restringido. Usa tu cuenta institucional creada en Firebase Authentication.</p>

      <div class="grid2">
        <div>
          <label for="loginEmail">Correo</label>
          <input id="loginEmail" type="email" placeholder="usuario@correo.com" autocomplete="username" />
        </div>

        <div>
          <label for="loginPassword">Contrase√±a</label>
          <div class="password-wrap">
            <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            <button id="btnTogglePassword" class="btn btn--ghost btn-eye" type="button" aria-label="Mostrar/ocultar contrase√±a">üëÅÔ∏è</button>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn btn--primary" id="btnLogin" type="button">Ingresar</button>
        <span class="muted small">Si dudas del correo, revisa Firebase ‚Üí Authentication ‚Üí Users</span>
      </div>

      <div id="loginMsg" class="msg" aria-live="polite"></div>
    </section>

    <!-- APP (solo visible DESPU√âS de login) -->
    <section class="app" id="appShell" hidden>
      <nav class="nav">
        <button class="tab is-active" data-tab="tabDashboard">Panel</button>
        <button class="tab" data-tab="tabEntries">Entradas</button>
        <button class="tab" data-tab="tabAssignments">Asignaci√≥n</button>
        <button class="tab" data-tab="tabScrap">Merma</button>
        <button class="tab" data-tab="tabRequests">Solicitudes</button>
        <button class="tab" data-tab="tabReports">Informes</button>
        <button class="tab admin-only" data-tab="tabEmployees" hidden>Empleados</button>
      </nav>

      <!-- DASHBOARD -->
      <section class="card tabpage" id="tabDashboard">
        <h2>Panel</h2>

        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">Entradas (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiEntries">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Asignaciones (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiAssignments">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Mermas (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiScrap">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Solicitudes pendientes</div>
            <div class="kpi-value" id="kpiPending">‚Äî</div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <h3>√öltimas entradas</h3>
            <div class="table-wrap">
              <table class="table" id="tblLastEntries">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Descripci√≥n</th>
                    <th class="right">Cant.</th>
                    <th class="right">Disp.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div>
            <h3>√öltimas asignaciones</h3>
            <div class="table-wrap">
              <table class="table" id="tblLastAssignments">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Trabajador</th>
                    <th>√çtem</th>
                    <th class="right">Cant.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="msg" id="dashMsg"></div>
      </section>

      <!-- ENTRADAS -->
      <section class="card tabpage" id="tabEntries" hidden>
        <h2>Entradas</h2>
        <p class="muted">Registro de entradas con stock disponible.</p>

        <div class="panel">
          <h3>Nueva entrada</h3>

          <div class="grid2">
            <div>
              <label for="entDate">Fecha</label>
              <input id="entDate" type="date" />
            </div>
            <div>
              <label for="entType">Tipo</label>
              <select id="entType">
                <option value="Insumo">Insumo</option>
                <option value="EPP">EPP</option>
                <option value="Documento">Documento</option>
                <option value="Otro">Otro</option>
              </select>
            </div>

            <div>
              <label for="entDesc">Descripci√≥n</label>
              <input id="entDesc" type="text" placeholder="Ej: Guantes, carpeta, etc." />
            </div>
            <div>
              <label for="entUnit">Unidad</label>
              <input id="entUnit" type="text" placeholder="Ej: unidad, caja, pack" />
            </div>

            <div>
              <label for="entQty">Cantidad</label>
              <input id="entQty" type="number" min="1" step="1" placeholder="Ej: 10" />
            </div>
            <div>
              <label for="entDoc">Documento/Referencia</label>
              <input id="entDoc" type="text" placeholder="OC / Gu√≠a / Memo / etc." />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" id="btnSaveEntry" type="button">Guardar entrada</button>
            <span class="muted small">Requiere rol: admin u operator</span>
          </div>

          <div class="msg" id="entMsg"></div>
        </div>

        <div class="panel">
          <h3>Listado de entradas</h3>

          <div class="row row--wrap">
            <input id="entSearch" type="text" placeholder="Buscar por texto..." />
            <select id="entFilterType">
              <option value="">Todos los tipos</option>
              <option value="Insumo">Insumo</option>
              <option value="EPP">EPP</option>
              <option value="Documento">Documento</option>
              <option value="Otro">Otro</option>
            </select>
            <button class="btn btn--ghost" id="btnReloadEntries" type="button">Actualizar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tblEntries">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Descripci√≥n</th>
                  <th>Unidad</th>
                  <th class="right">Cantidad</th>
                  <th class="right">Disponible</th>
                  <th>Ref.</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="msg" id="entListMsg"></div>
        </div>
      </section>

      <!-- ASIGNACIONES -->
      <section class="card tabpage" id="tabAssignments" hidden>
        <h2>Asignaci√≥n a trabajador</h2>
        <p class="muted">Asigna un √≠tem a un trabajador registrado. Descuenta stock disponible.</p>

        <div class="panel">
          <h3>Nueva asignaci√≥n</h3>

          <div class="grid2">
            <div>
              <label for="asEntry">Entrada (√≠tem)</label>
              <select id="asEntry"></select>
            </div>
            <div>
              <label for="asDate">Fecha</label>
              <input id="asDate" type="date" />
            </div>

            <div>
              <label for="asWorker">Trabajador</label>
              <select id="asWorker"></select>
              <div class="muted small">Se carga desde Firestore ‚Üí employees</div>
            </div>

            <div>
              <label for="asQty">Cantidad asignada</label>
              <input id="asQty" type="number" min="1" step="1" placeholder="Ej: 2" />
            </div>

            <div class="span2">
              <label for="asReason">Motivo / Observaci√≥n</label>
              <input id="asReason" type="text" placeholder="Ej: Entrega de EPP para actividad X" />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" id="btnSaveAssign" type="button">Guardar asignaci√≥n</button>
            <span class="muted small">Requiere rol: admin u operator</span>
          </div>

          <div class="msg" id="asMsg"></div>
        </div>

        <div class="panel">
          <h3>Listado de asignaciones</h3>

          <div class="row row--wrap">
            <input id="asSearch" type="text" placeholder="Buscar trabajador o descripci√≥n..." />
            <button class="btn btn--ghost" id="btnReloadAssignments" type="button">Actualizar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tblAssignments">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Trabajador</th>
                  <th>√çtem</th>
                  <th class="right">Cantidad</th>
                  <th>Motivo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="msg" id="asListMsg"></div>
        </div>
      </section>

      <!-- MERMA -->
      <section class="card tabpage" id="tabScrap" hidden>
        <h2>Registro de merma</h2>
        <p class="muted">Registra una merma y descuenta stock disponible.</p>

        <div class="panel">
          <h3>Nueva merma</h3>

          <div class="grid2">
            <div>
              <label for="scEntry">Entrada (√≠tem)</label>
              <select id="scEntry"></select>
            </div>
            <div>
              <label for="scDate">Fecha</label>
              <input id="scDate" type="date" />
            </div>

            <div>
              <label for="scQty">Cantidad</label>
              <input id="scQty" type="number" min="1" step="1" placeholder="Ej: 1" />
            </div>
            <div>
              <label for="scReason">Motivo</label>
              <select id="scReason">
                <option value="Deterioro">Deterioro</option>
                <option value="Vencimiento">Vencimiento</option>
                <option value="P√©rdida">P√©rdida</option>
                <option value="Otro">Otro</option>
              </select>
            </div>

            <div class="span2">
              <label for="scDetail">Detalle (si motivo = "Otro")</label>
              <input id="scDetail" type="text" placeholder="Explica el motivo..." />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" id="btnSaveScrap" type="button">Guardar merma</button>
            <span class="muted small">Requiere rol: admin u operator</span>
          </div>

          <div class="msg" id="scMsg"></div>
        </div>

        <div class="panel">
          <h3>Listado de mermas</h3>

          <div class="row row--wrap">
            <input id="scSearch" type="text" placeholder="Buscar motivo o descripci√≥n..." />
            <button class="btn btn--ghost" id="btnReloadScrap" type="button">Actualizar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tblScrap">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>√çtem</th>
                  <th class="right">Cantidad</th>
                  <th>Motivo</th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="msg" id="scListMsg"></div>
        </div>
      </section>

      <!-- SOLICITUDES -->
      <section class="card tabpage" id="tabRequests" hidden>
        <h2>Solicitudes / Consultas v√≠a web</h2>
        <p class="muted">Cualquier usuario autenticado puede registrar solicitudes. Admin/Operator puede responder.</p>

        <div class="panel">
          <h3>Nueva solicitud</h3>

          <div class="grid2">
            <div>
              <label for="rqType">Tipo</label>
              <select id="rqType">
                <option value="Solicitud">Solicitud</option>
                <option value="Consulta">Consulta</option>
                <option value="Reporte">Reporte</option>
                <option value="Correcci√≥n">Correcci√≥n</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div>
              <label for="rqPriority">Prioridad</label>
              <select id="rqPriority">
                <option value="Baja">Baja</option>
                <option value="Media">Media</option>
                <option value="Alta">Alta</option>
              </select>
            </div>

            <div class="span2">
              <label for="rqDetail">Detalle</label>
              <input id="rqDetail" type="text" placeholder="Describe la solicitud..." />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" id="btnSaveRequest" type="button">Enviar solicitud</button>
          </div>

          <div class="msg" id="rqMsg"></div>
        </div>

        <div class="panel">
          <h3>Listado de solicitudes</h3>

          <div class="row row--wrap">
            <select id="rqFilterStatus">
              <option value="">Todos</option>
              <option value="Pendiente">Pendiente</option>
              <option value="Respondida">Respondida</option>
            </select>
            <button class="btn btn--ghost" id="btnReloadRequests" type="button">Actualizar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tblRequests">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Prioridad</th>
                  <th>Detalle</th>
                  <th>Estado</th>
                  <th>Respuesta</th>
                  <th class="right">Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="msg" id="rqListMsg"></div>
        </div>
      </section>

      <!-- INFORMES -->
      <section class="card tabpage" id="tabReports" hidden>
        <h2>Informes</h2>
        <p class="muted">Reportes por trabajador y resumen global (Entradas, Asignaciones, Mermas, Stock restante).</p>

        <div class="panel">
          <h3>Par√°metros</h3>

          <div class="grid2">
            <div>
              <label for="rpWorker">Trabajador</label>
              <select id="rpWorker"></select>
              <div class="muted small">Se carga desde Firestore ‚Üí employees</div>
            </div>

            <div>
              <label for="rpFrom">Desde (opcional)</label>
              <input id="rpFrom" type="date" />
            </div>
            <div>
              <label for="rpTo">Hasta (opcional)</label>
              <input id="rpTo" type="date" />
            </div>

            <div>
              <label for="rpMode">Vista</label>
              <select id="rpMode">
                <option value="worker">Por trabajador (detalle + resumen)</option>
                <option value="global">Resumen global (stock)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" id="btnRunReport" type="button">Generar informe</button>
            <button class="btn btn--ghost" id="btnExportCSV" type="button" disabled>Exportar CSV</button>
          </div>

          <div class="msg" id="rpMsg"></div>
        </div>

        <div class="panel">
          <h3>Resumen</h3>
          <div class="kpis kpis-4">
            <div class="kpi">
              <div class="kpi-label">Total entradas</div>
              <div class="kpi-value" id="rpKpiIn">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Total asignaciones</div>
              <div class="kpi-value" id="rpKpiAs">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Total mermas</div>
              <div class="kpi-value" id="rpKpiSc">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Stock restante total</div>
              <div class="kpi-value" id="rpKpiRemain">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>Resultados</h3>
          <div class="table-wrap">
            <table class="table" id="tblReport">
              <thead>
                <tr>
                  <th>Concepto</th>
                  <th class="right">Cantidad</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLEADOS (solo admin) -->
      <section class="card tabpage" id="tabEmployees" hidden>
        <h2>Gesti√≥n de empleados (Admin)</h2>
        <p class="muted">Crea usuarios para el sistema y asigna roles de acceso (admin / operator / consulta).</p>

        <div class="panel">
          <h3>Crear nuevo empleado</h3>

          <div class="grid2">
            <div>
              <label for="empFirst">Nombre</label>
              <input id="empFirst" type="text" placeholder="Ej: Maritza" />
            </div>
            <div>
              <label for="empLast">Apellidos</label>
              <input id="empLast" type="text" placeholder="Ej: Aguila" />
            </div>

            <div>
              <label for="empEmail">Correo</label>
              <input id="empEmail" type="email" placeholder="empleado@correo.com" />
            </div>
            <div>
              <label for="empPass">Clave</label>
              <input id="empPass" type="password" placeholder="M√≠nimo 6 caracteres" />
            </div>

            <div>
              <label for="empRole">Rol</label>
              <select id="empRole">
                <option value="consulta">consulta</option>
                <option value="operator">operator</option>
                <option value="admin">admin</option>
              </select>
            </div>

            <div class="span2">
              <div class="row">
                <button class="btn btn--primary" id="btnCreateEmployee" type="button">Crear empleado</button>
                <span class="muted small">Se crea en Authentication + Firestore (users y employees)</span>
              </div>
            </div>
          </div>

          <div class="msg" id="empMsg"></div>
        </div>

        <div class="panel">
          <h3>Listado de empleados</h3>

          <div class="row row--wrap">
            <button class="btn btn--ghost" id="btnReloadEmployees" type="button">Actualizar</button>
          </div>

          <div class="table-wrap">
            <table class="table" id="tblEmployees">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>Rol</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="msg" id="empListMsg"></div>
        </div>
      </section>

      <footer class="foot">
        <div class="muted small">
          MVP acad√©mico ‚Ä¢ APA ‚Ä¢ Firebase Auth + Firestore ‚Ä¢ Roles: admin/operator/consulta
        </div>
      </footer>
    </section>
  </main>

  <noscript>
    <div class="noscript">Esta aplicaci√≥n requiere JavaScript para funcionar.</div>
  </noscript>

  <script type="module" src="./app.js"></script>
</body>
</html>

