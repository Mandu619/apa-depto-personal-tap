<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Registros | APA - Depto. Personal</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <noscript>
    <div class="noscript">
      Esta aplicaci√≥n requiere JavaScript habilitado para funcionar.
    </div>
  </noscript>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">APA</div>
      <div>
        <div class="title">Sistema de Registros</div>
        <div class="subtitle">Depto. Personal ‚Ä¢ Entradas ‚Ä¢ Asignaciones ‚Ä¢ Merma ‚Ä¢ Solicitudes ‚Ä¢ Informes</div>
      </div>
    </div>

    <div class="userbox" id="userBox">
      <div class="user-meta">
        <div class="user-name" id="userName">No autenticado</div>
        <div class="user-role" id="userRole">‚Äî</div>
      </div>
      <button class="btn btn--danger" id="btnLogout" type="button" disabled>Salir</button>
    </div>
  </header>

  <main class="container">

    <!-- LOGIN (solo esto se ve sin sesi√≥n) -->
    <section class="login-wrap" id="loginWrap">
      <div class="card login-card" id="loginCard">
        <h2>Ingreso al sistema</h2>
        <p class="muted small">
          Ingresa con el usuario creado en Firebase Authentication. Si no tienes acceso, solicita creaci√≥n de cuenta al Administrador.
        </p>

        <div class="grid2">
          <div>
            <label for="loginEmail">Correo</label>
            <input id="loginEmail" type="email" placeholder="nombre@dominio.cl" autocomplete="username" />
          </div>

          <div>
            <label for="loginPassword">Contrase√±a</label>
            <div class="password-wrap">
              <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
              <button id="btnTogglePassword" class="btn btn--ghost btn-eye" type="button" aria-label="Mostrar/ocultar contrase√±a">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <div class="row">
          <button id="btnLogin" class="btn btn--primary" type="button">Ingresar</button>
          <span class="muted small">Tip: si dudas del correo, revisa Firebase ‚Üí Authentication ‚Üí Users</span>
        </div>

        <div id="loginMsg" class="msg info">Ingresa tus credenciales para continuar.</div>

        <div class="login-foot muted small">
          MVP acad√©mico ‚Ä¢ APA ‚Ä¢ Firebase Auth + Firestore ‚Ä¢ Roles: admin/operator/consulta
        </div>
      </div>
    </section>

    <!-- APP SHELL (todo lo dem√°s se oculta hasta logueo) -->
    <section class="app" id="appShell" hidden>

      <!-- NAV TABS -->
      <nav class="nav" id="navTabs" hidden>
        <button class="tab active" data-view="view-dashboard" type="button">Panel</button>
        <button class="tab" data-view="view-entries" type="button">Entradas</button>
        <button class="tab" data-view="view-assign" type="button">Asignaci√≥n</button>
        <button class="tab" data-view="view-scrap" type="button">Merma</button>
        <button class="tab" data-view="view-requests" type="button">Solicitudes</button>
        <button class="tab" data-view="view-reports" type="button">Informes</button>

        <!-- Solo admin (el JS lo oculta si no corresponde) -->
        <button class="tab" data-view="view-employees" type="button" hidden>Empleados</button>
      </nav>

      <!-- DASHBOARD -->
      <section class="card view" id="view-dashboard" hidden>
        <h2>Panel</h2>

        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">Entradas (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiEntries">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Asignaciones (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiAssignments">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Mermas (√∫ltimos 30 d√≠as)</div>
            <div class="kpi-value" id="kpiScrap">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Solicitudes pendientes</div>
            <div class="kpi-value" id="kpiPending">0</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <div class="panel">
            <h3>√öltimas entradas</h3>
            <div class="table-wrap">
              <table class="table" id="tblLastEntries">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Descripci√≥n</th>
                    <th class="right">Cant.</th>
                    <th class="right">Disp.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <h3>√öltimas asignaciones</h3>
            <div class="table-wrap">
              <table class="table" id="tblLastAssignments">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Trabajador</th>
                    <th>√çtem</th>
                    <th class="right">Cant.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="msg ok" id="dashMsg">Panel actualizado.</div>
      </section>

      <!-- ENTRADAS -->
      <section class="card view" id="view-entries" hidden>
        <h2>Registro de Entradas</h2>

        <form id="formEntry">
          <div class="grid2">
            <div>
              <label for="entryDate">Fecha</label>
              <input id="entryDate" type="date" />
            </div>
            <div>
              <label for="entryType">Tipo</label>
              <select id="entryType">
                <option value="">Seleccionar‚Ä¶</option>
                <option value="EPP">EPP</option>
                <option value="Uniforme">Uniforme</option>
                <option value="Oficina">Oficina</option>
                <option value="Aseo">Aseo</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="entryDesc">Descripci√≥n</label>
              <input id="entryDesc" type="text" placeholder="Ej: Guantes, Papel, T√≥ner..." />
            </div>
            <div>
              <label for="entryRef">Referencia (opcional)</label>
              <input id="entryRef" type="text" placeholder="OC / Factura / Gu√≠a..." />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="entryQty">Cantidad</label>
              <input id="entryQty" type="number" min="1" step="1" />
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn btn--primary" type="submit">Guardar entrada</button>
              <button class="btn btn--ghost" id="btnReloadEntries" type="button">Actualizar</button>
            </div>
          </div>

          <div id="entryMsg" class="msg"></div>
        </form>

        <div class="panel">
          <div class="grid2">
            <div>
              <label for="filterEntryType">Filtro por tipo</label>
              <select id="filterEntryType">
                <option value="">(Todos)</option>
                <option value="EPP">EPP</option>
                <option value="Uniforme">Uniforme</option>
                <option value="Oficina">Oficina</option>
                <option value="Aseo">Aseo</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div>
              <label for="filterEntryText">Buscar</label>
              <input id="filterEntryText" type="text" placeholder="Descripci√≥n / referencia..." />
            </div>
          </div>

          <div class="table-wrap" style="margin-top:12px;">
            <table class="table" id="tblEntries">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Descripci√≥n</th>
                  <th>Ref.</th>
                  <th class="right">Cant.</th>
                  <th class="right">Disp.</th>
                  <th>Creado por</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ASIGNACION -->
      <section class="card view" id="view-assign" hidden>
        <h2>Asignaci√≥n a Trabajador</h2>

        <form id="formAssign">
          <div class="grid2">
            <div>
              <label for="assignDate">Fecha</label>
              <input id="assignDate" type="date" />
            </div>
            <div>
              <label for="assignEntryId">√çtem (desde entradas)</label>
              <select id="assignEntryId">
                <option value="">Seleccionar‚Ä¶</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="assignWorkerSelect">Trabajador (desde base de datos)</label>
              <select id="assignWorkerSelect">
                <option value="">(Seleccionar trabajador)</option>
              </select>
              <div class="muted small">Si no aparece, el admin debe crear empleados en la pesta√±a ‚ÄúEmpleados‚Äù.</div>
            </div>
            <div>
              <label for="assignWorker">Trabajador (manual, opcional)</label>
              <input id="assignWorker" type="text" placeholder="Ej: Cabo Alonso Parraguez" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="assignQty">Cantidad</label>
              <input id="assignQty" type="number" min="1" step="1" />
            </div>
            <div>
              <label for="assignReason">Motivo</label>
              <input id="assignReason" type="text" placeholder="Ej: Entrega EPP / Necesidad operativa..." />
            </div>
          </div>

          <div class="row">
            <button class="btn btn--primary" type="submit">Guardar asignaci√≥n</button>
            <button class="btn btn--ghost" id="btnReloadAssignments" type="button">Actualizar</button>
          </div>

          <div id="assignMsg" class="msg"></div>
        </form>

        <div class="panel">
          <div class="grid2">
            <div>
              <label for="filterAssignWorker">Buscar trabajador</label>
              <input id="filterAssignWorker" type="text" placeholder="Nombre..." />
            </div>
            <div class="grid2">
              <div>
                <label for="filterAssignFrom">Desde</label>
                <input id="filterAssignFrom" type="date" />
              </div>
              <div>
                <label for="filterAssignTo">Hasta</label>
                <input id="filterAssignTo" type="date" />
              </div>
            </div>
          </div>

          <div class="table-wrap" style="margin-top:12px;">
            <table class="table" id="tblAssignments">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Trabajador</th>
                  <th>ID Entrada</th>
                  <th>Tipo</th>
                  <th>Descripci√≥n</th>
                  <th class="right">Cant.</th>
                  <th>Creado por</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="assignListMsg" class="msg"></div>
        </div>
      </section>

      <!-- MERMA -->
      <section class="card view" id="view-scrap" hidden>
        <h2>Registro de Merma</h2>

        <form id="formScrap">
          <div class="grid2">
            <div>
              <label for="scrapDate">Fecha</label>
              <input id="scrapDate" type="date" />
            </div>
            <div>
              <label for="scrapEntryId">√çtem (desde entradas)</label>
              <select id="scrapEntryId">
                <option value="">Seleccionar‚Ä¶</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="scrapQty">Cantidad</label>
              <input id="scrapQty" type="number" min="1" step="1" />
            </div>
            <div>
              <label for="scrapReason">Motivo</label>
              <select id="scrapReason">
                <option value="">Seleccionar‚Ä¶</option>
                <option value="Vencimiento">Vencimiento</option>
                <option value="Da√±o">Da√±o</option>
                <option value="P√©rdida">P√©rdida</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <div>
            <label for="scrapDetail">Detalle (solo si motivo = "Otro")</label>
            <input id="scrapDetail" type="text" placeholder="Describe el motivo..." />
          </div>

          <div class="row">
            <button class="btn btn--primary" type="submit">Guardar merma</button>
          </div>

          <div id="scrapMsg" class="msg"></div>
        </form>

        <div class="panel">
          <div class="table-wrap">
            <table class="table" id="tblScrap">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>ID Entrada</th>
                  <th>Tipo</th>
                  <th>Descripci√≥n</th>
                  <th class="right">Cant.</th>
                  <th>Motivo</th>
                  <th>Creado por</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SOLICITUDES -->
      <section class="card view" id="view-requests" hidden>
        <h2>Solicitudes</h2>

        <form id="formRequest">
          <div class="grid2">
            <div>
              <label for="reqType">Tipo</label>
              <select id="reqType">
                <option value="">Seleccionar‚Ä¶</option>
                <option value="Consulta">Consulta</option>
                <option value="Requerimiento">Requerimiento</option>
                <option value="Incidente">Incidente</option>
                <option value="Solicitud">Solicitud</option>
              </select>
            </div>
            <div>
              <label for="reqPriority">Prioridad</label>
              <select id="reqPriority">
                <option value="Normal">Normal</option>
                <option value="Alta">Alta</option>
              </select>
            </div>
          </div>

          <div>
            <label for="reqText">Detalle</label>
            <input id="reqText" type="text" placeholder="Describe tu solicitud..." />
          </div>

          <div class="row">
            <button class="btn btn--primary" type="submit">Crear solicitud</button>
            <button class="btn btn--ghost" id="btnReloadRequests" type="button">Actualizar</button>
          </div>

          <div id="reqMsg" class="msg"></div>
        </form>

        <div class="panel">
          <div class="grid2">
            <div>
              <label for="filterReqStatus">Estado</label>
              <select id="filterReqStatus">
                <option value="">(Todos)</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Respondida">Respondida</option>
              </select>
            </div>
            <div>
              <label for="filterReqText">Buscar</label>
              <input id="filterReqText" type="text" placeholder="Tipo / detalle..." />
            </div>
          </div>

          <div class="table-wrap" style="margin-top:12px;">
            <table class="table" id="tblRequests">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Prioridad</th>
                  <th>Estado</th>
                  <th>Respuesta</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="reqListMsg" class="msg"></div>
        </div>
      </section>

      <!-- INFORMES -->
      <section class="card view" id="view-reports" hidden>
        <h2>Informes</h2>

        <div class="panel">
          <div class="grid2">
            <div>
              <label for="reportMode">Modo de reporte</label>
              <select id="reportMode">
                <option value="worker">Por trabajador</option>
                <option value="type">Por tipo de entrada</option>
              </select>
            </div>

            <div>
              <label for="reportWorkerSelect">Trabajador (desde base de datos)</label>
              <select id="reportWorkerSelect">
                <option value="">(Todos / sin filtro)</option>
              </select>
              <div class="muted small">Opcional: si no seleccionas, muestra todos.</div>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="reportFilter">Filtro manual (opcional)</label>
              <input id="reportFilter" type="text" placeholder="Ej: Maritza / EPP" />
            </div>

            <div class="grid2">
              <div>
                <label for="reportFrom">Desde</label>
                <input id="reportFrom" type="date" />
              </div>
              <div>
                <label for="reportTo">Hasta</label>
                <input id="reportTo" type="date" />
              </div>
            </div>
          </div>

          <div class="row row--wrap">
            <button id="btnRunReport" class="btn btn--primary" type="button">Generar informe</button>
            <button id="btnExportCSV" class="btn btn--ghost" type="button" disabled>Exportar CSV</button>
          </div>

          <div id="reportMsg" class="msg"></div>

          <div class="grid2" style="margin-top:12px;">
            <div class="kpi">
              <div class="kpi-label">Registros</div>
              <div class="kpi-value" id="reportCount">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Cantidad total (movimientos)</div>
              <div class="kpi-value" id="reportQty">0</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div class="kpi">
              <div class="kpi-label">Total merma (seg√∫n filtro)</div>
              <div class="kpi-value" id="reportScrapTotal">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Stock total restante (global)</div>
              <div class="kpi-value" id="reportRemainingTotal">0</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="table-wrap">
            <table class="table" id="tblReport">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Trabajador</th>
                  <th>ID Entrada</th>
                  <th>Descripci√≥n</th>
                  <th class="right">Cant.</th>
                  <th>Motivo/Mov.</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMPLEADOS (ADMIN) -->
      <section class="card view" id="view-employees" hidden>
        <h2>Gesti√≥n de Empleados (Admin)</h2>
        <p class="muted small">
          Crea usuarios del sistema. Se registran en Firebase Authentication y se guardan perfiles en Firestore (employees y users).
        </p>

        <div class="panel">
          <div class="grid2">
            <div>
              <label for="empFirst">Nombre</label>
              <input id="empFirst" type="text" placeholder="Ej: Rodrigo" />
            </div>
            <div>
              <label for="empLast">Apellidos</label>
              <input id="empLast" type="text" placeholder="Ej: Arancibia" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="empEmail">Correo</label>
              <input id="empEmail" type="email" placeholder="correo@dominio.cl" />
            </div>
            <div>
              <label for="empPass">Clave (m√≠nimo 6)</label>
              <div class="password-wrap">
                <input id="empPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                <button id="btnToggleEmpPass" class="btn btn--ghost btn-eye" type="button" aria-label="Mostrar/ocultar contrase√±a">üëÅÔ∏è</button>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="empRole">Rol</label>
              <select id="empRole">
                <option value="consulta">consulta</option>
                <option value="operator">operator</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div>
              <label for="empActive">Activo</label>
              <select id="empActive">
                <option value="true">S√≠</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>

          <div class="row row--wrap">
            <button id="btnCreateEmployee" class="btn btn--primary" type="button">Crear empleado</button>
            <button id="btnReloadEmployees" class="btn btn--ghost" type="button">Actualizar listado</button>
          </div>

          <div id="empMsg" class="msg"></div>
        </div>

        <div class="panel">
          <h3>Listado de empleados</h3>
          <div class="table-wrap">
            <table class="table" id="tblEmployees">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>Rol</th>
                  <th>Activo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="empListMsg" class="msg"></div>
        </div>
      </section>

      <div class="foot muted small">
        MVP acad√©mico ‚Ä¢ APA ‚Ä¢ Firebase Auth + Firestore ‚Ä¢ Roles: admin/operator/consulta
      </div>

    </section>
  </main>

  <!-- JS -->
  <script type="module" src="./app.js"></script>
</body>
</html>


